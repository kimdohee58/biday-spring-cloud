pipeline {
    agent any

    environment {
        WORKSPACE_PATH = "/var/lib/jenkins/workspace/biday-msa/backend"
        DOCKER_HUB_URL = "${docker_hub_url}"
        GITHUB_URL = "${github_url}"
        DOCKER_HUB_CREDENTIALS = 'dockerhub'
        GIT_SSH_CREDENTIALS = 'git_ssh'
        DOCKER_HUB_REPO = "hwijae/biday"
        SLACK_CHANNEL = '#jenkins-log'
        KUBECONFIG = "/var/lib/jenkins/.kube/config"
    }

    tools {
        jdk 'openjdk_17'
        gradle 'gradle_8.10'
    }

    stages {
        stage('Initialize') {
            steps {
                script {
                    modulePaths = [
                        "config-server": "${WORKSPACE_PATH}/server/config-server",
                        "eureka-server": "${WORKSPACE_PATH}/server/eureka-server",
                        "gateway-server": "${WORKSPACE_PATH}/server/gateway-server",
                        "admin-service": "${WORKSPACE_PATH}/service/admin-service",
                        "auction-service": "${WORKSPACE_PATH}/service/auction-service",
                        "ftp-service": "${WORKSPACE_PATH}/service/ftp-service",
                        "order-service": "${WORKSPACE_PATH}/service/order-service",
                        "product-service": "${WORKSPACE_PATH}/service/product-service",
                        "sms-service": "${WORKSPACE_PATH}/service/sms-service",
                        "user-service": "${WORKSPACE_PATH}/service/user-service"
                    ]
                }
            }
        }

        stage('Github Checkout') {
            steps {
                checkout scmGit(
                    branches: [[name: '*/dev']],
                    extensions: [
                        submodule(parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: true)
                    ],
                    userRemoteConfigs: [
                        [credentialsId: GIT_SSH_CREDENTIALS, url: GITHUB_URL]
                    ]
                )
            }
        }

        stage('Gradle Build') {
            steps {
                echo '=== build modules shell script start ==='
                dir('backend') {
                    script {
                        sh 'chmod +x buildModule.sh'
                        sh './buildModule.sh'
                    }
                }
            }
        }

        stage('Docker Login') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'DockerHub_IdPw', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh "echo ${DOCKER_PASSWORD} | docker login -u ${DOCKER_USERNAME} --password-stdin"
                    }
                }
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    modulePaths.each { module, path ->
                        echo "Building Docker image for ${module}..."
                        sh """
                            docker build -t biday/${module}:latest ${path} --file ${path}/Dockerfile || {
                                echo 'Docker build failed for ${module} at ${path}';
                                exit 1;
                            }
                        """
                    }
                }
            }
        }

        stage('Docker Push') {
            steps {
                script {
                    def version = "${BUILD_TAG}"

                    modulePaths.each { module, path ->
                        echo "Tagging and pushing ${module}..."
                        sh """
                            docker tag biday/${module}:latest hwijae/biday-${module}:${version} || { echo 'Docker tag failed for ${module}!'; exit 1; }
                            docker push hwijae/biday-${module}:${version} || { echo 'Docker push failed for ${module}!'; exit 1; }
                        """
                    }

                    echo "Docker images pushed successfully!"
                }
            }
            post {
                success {
                    echo "Docker push completed successfully!"
                }
                failure {
                    echo "Docker push failed!"
                    error 'Docker push failed'
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // Kubernetes YAML íŒŒì¼ ê²½ë¡œ ì •ì˜
                    def kubernetesPaths = [
                        "config-server": "${WORKSPACE_PATH}/k8s/config.yaml",
                        "eureka-server": "${WORKSPACE_PATH}/k8s/eureka.yaml",
                        "gateway-server": "${WORKSPACE_PATH}/k8s/gateway.yaml",
                        "admin-service": "${WORKSPACE_PATH}/k8s/admin.yaml",
                        "auction-service": "${WORKSPACE_PATH}/k8s/auction.yaml",
                        "ftp-service": "${WORKSPACE_PATH}/k8s/ftp.yaml",
                        "order-service": "${WORKSPACE_PATH}/k8s/order.yaml",
                        "product-service": "${WORKSPACE_PATH}/k8s/product.yaml",
                        "user-service": "${WORKSPACE_PATH}/k8s/user.yaml"
                    ]

                    // ê° ëª¨ë“ˆì— ëŒ€í•´ Kubernetes ë°°í¬ ìˆ˜í–‰
                    kubernetesPaths.each { module, yamlPath ->
                        echo "Applying Kubernetes deployment for ${module} using YAML file: ${yamlPath}"

                        // YAML íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ ì ìš©
                        sh """
                        kubectl apply -f ${yamlPath} || {
                            echo 'Kubernetes deployment failed for ${module}';
                            exit 1;
                        }
                        """

                    }
                }
            }
        }
    }

    post {
        success {
            echo "========pipeline executed successfully ========"

            // ìŠ¬ë™ ì„±ê³µ ë©”ì‹œì§€ ë³´ë‚´ê¸°
            slackSend(
                channel: env.SLACK_CHANNEL,
                attachments: [
                    [
                        text: "ë°±ì—”ë“œ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€",
                        footer: "ë°°í¬ ì‹œê°„: ${new Date()}",
                        color: "#00FF00" // ì´ˆë¡ìƒ‰
                    ]
                ],
                message: "ë°°í¬ ì„±ê³µ!",
                tokenCredentialId: 'Slack_webhook' // ìê²© ì¦ëª… ID ì…ë ¥
            )

             script {
                 modulePaths.keySet().each { module ->
                     echo "Removing local image for ${module}..."
                     // ë¡œì»¬ ë„ì»¤ ì´ë¯¸ì§€ ì‚­ì œ
                     sh "docker rmi biday/${module} || echo 'Failed to remove local image for ${module}'"
                     sh "docker rmi hwijae/biday-${module}:1.0 || echo 'Failed to remove tagged image for ${module}'"
                 }
             }
        }
        failure {
            echo "========pipeline execution failed========"

            // ìŠ¬ë™ ì‹¤íŒ¨ ë©”ì‹œì§€ ë³´ë‚´ê¸°
            slackSend(
                channel: env.SLACK_CHANNEL,
                attachments: [
                    [
                        text: "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ¥²",
                        footer: "ì˜¤ë¥˜ ë°œìƒ ì‹œê°„: ${new Date()}",
                        color: "#FF0000" // ë¹¨ê°„ìƒ‰
                    ]
                ],
                message: "ë°°í¬ ì‹¤íŒ¨!",
                tokenCredentialId: 'Slack_webhook' // ìê²© ì¦ëª… ID ì…ë ¥
            )
        }
        always {
            echo 'Cleaning workspace...'
        }
    }
}
